# Тестирование единой системы смены языка

## Описание системы

Теперь у вас есть единая система смены языка, которая синхронизирует язык между лендингом и CRM:

1. **Лендинг** - использует API `/api/languages/set/{code}` для смены языка
2. **CRM** - также использует API `/api/languages/set/{code}` для смены языка
3. **Middleware** - автоматически синхронизирует язык между системами

## Как это работает

### При смене языка на лендинге:
1. Пользователь кликает на флаг языка в header
2. JavaScript отправляет запрос на `/api/languages/set/{code}`
3. Язык сохраняется в сессии и в проекте (если пользователь авторизован)
4. Показывается уведомление об успешной смене
5. Страница перезагружается с новым языком

### При смене языка в CRM:
1. Пользователь выбирает язык в настройках или кликает на флаг
2. JavaScript отправляет запрос на `/api/languages/set/{code}`
3. Язык сохраняется в сессии и в проекте
4. Показывается уведомление с предложением перейти на лендинг
5. Страница перезагружается с новым языком

### При переходе между системами:
1. Middleware автоматически определяет текущий язык из сессии
2. Если язык был изменен на лендинге, он автоматически применяется в CRM
3. Если язык был изменен в CRM, он автоматически применяется на лендинге

## Тестирование

### 1. Тест смены языка на лендинге:
1. Откройте лендинг (например, `/beautyflow`)
2. Кликните на флаг языка в header
3. Проверьте, что язык изменился
4. Проверьте, что появилось уведомление об успехе
5. Перейдите в CRM
6. Проверьте, что язык автоматически синхронизировался

### 2. Тест смены языка в CRM:
1. Откройте CRM
2. Перейдите в настройки и измените язык
3. Проверьте, что язык изменился
4. Проверьте, что появилось уведомление с предложением перейти на лендинг
5. Перейдите на лендинг
6. Проверьте, что язык автоматически синхронизировался

### 3. Тест прямой смены через URL:
1. Откройте лендинг с параметром языка: `/beautyflow?lang=en`
2. Проверьте, что язык изменился на английский
3. Перейдите в CRM
4. Проверьте, что язык остался английским

## Логирование

Система ведет подробные логи в `storage/logs/laravel.log`:

- Запуск middleware
- Параметры языка из URL
- Язык из сессии
- Обновление языка в проекте
- Синхронизация между системами

## Возможные проблемы и решения

### 1. Язык не сохраняется после перезагрузки:
- Проверьте, что middleware SetLanguage подключен в группе 'web'
- Проверьте, что сессии работают корректно
- Проверьте логи на наличие ошибок

### 2. Язык не синхронизируется между системами:
- Проверьте, что API `/api/languages/set/{code}` доступен
- Проверьте, что middleware правильно обрабатывает сессии
- Проверьте логи middleware

### 3. Уведомления не показываются:
- Проверьте, что JavaScript код загружается
- Проверьте консоль браузера на наличие ошибок
- Проверьте, что Bootstrap CSS подключен

## Файлы, которые были изменены:

1. `app/Http/Middleware/SetLanguage.php` - обновлен middleware для синхронизации
2. `app/Http/Controllers/Api/LanguageController.php` - добавлены URL лендинга
3. `app/Helpers/LanguageHelper.php` - добавлен метод синхронизации
4. `app/Http/Controllers/Client/SettingsController.php` - добавлена установка языка в сессию
5. `public/client/js/language-manager.js` - добавлены уведомления и localStorage
6. `resources/views/landing/components/header.blade.php` - обновлен для использования API
7. `resources/views/client/layouts/app.blade.php` - добавлено уведомление о синхронизации
8. Файлы переводов - добавлены новые ключи

## Команды для очистки кэша:

```bash
php artisan config:clear
php artisan route:clear
php artisan view:clear
php artisan cache:clear
```

## Проверка работы:

1. Очистите кэш браузера
2. Проверьте логи в `storage/logs/laravel.log`
3. Протестируйте смену языка на лендинге
4. Протестируйте смену языка в CRM
5. Проверьте синхронизацию между системами
